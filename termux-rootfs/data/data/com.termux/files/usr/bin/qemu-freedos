#!/data/data/com.termux/files/usr/bin/bash
##
##  Run a Free DOS
##
##  Leonid Plyushch (C) 2017
##
##  This program is free software: you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation, either version 3 of the License, or
##  (at your option) any later version.
##
##  This program is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

FREEDOS_FLOPPY="${PREFIX}/share/qemu/OS/FreeDOS.qcow2"
FREEDOS_SNAPSHOT="${PREFIX}/var/lib/qemu/FreeDOS.snap.qcow2"

if [ "${1}" = "-h" ] || [ "${1}" = "--help" ]; then
    echo
    echo " Usage: qemu-freedos [-h|--help|-r|--reset]"
    echo
    echo " Run a Free DOS in QEMU."
    echo
    echo " Options:"
    echo "  -h, --help      Show this help"
    echo
    echo "  -r, --reset     Reset snapshot. Removes all changes"
    echo "                  that was done to HDD image."
    echo
    echo " Environment variables:"
    echo "  VNC_DISPLAY     Set a display on which VNC server will"
    echo "                  be started. For example, if display is"
    echo "                  specified as ':5', then VNC server will"
    echo "                  listen on port '5905'."
    echo
    exit 0
elif [ "${1}" = "-r" ] || [ "${1}" = "--reset" ]; then
    echo -n "[*] Removing snapshot... "
    if rm -f "${FREEDOS_SNAPSHOT}" > /dev/null 2>&1; then
        echo "OK"
    else
        echo "FAIL"
        exit 1
    fi
fi

if [ ! -z "${VNC_DISPLAY}" ]; then
    if ! grep -qP '^:\d{1,3}$' <(echo "${VNC_DISPLAY}"); then
        echo "[!] Invalid VNC display specified: '${VNC_DISPLAY}'."
        exit 1
    fi

    QEMU_DISPLAY="-display vnc="${VNC_DISPLAY}""
else
    QEMU_DISPLAY=""
fi

if [ ! -e "${FREEDOS_SNAPSHOT}" ]; then
    echo -n "[*] Creating new snapshot... "
    if qemu-img create -f qcow2 -b "${FREEDOS_FLOPPY}" "${FREEDOS_SNAPSHOT}" > /dev/null 2>&1; then
        echo "OK"
    else
        echo "FAIL"
        exit 1
    fi
fi

echo "[*] Starting Free DOS..."
if [ ! -z "${QEMU_DISPLAY}" ]; then
    VNC_PORT=$((${VNC_DISPLAY//:} + 5900))
    echo
    echo "    VNC: 127.0.0.1:${VNC_PORT}"
    echo
fi

exec qemu-system-i386 ${QEMU_DISPLAY} -m 32 -fda "${FREEDOS_SNAPSHOT}"
